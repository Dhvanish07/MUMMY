<!DOCTYPE html>
<html>
<head>
    <title>API Test - MUMMY</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .test-container { max-width: 1000px; margin: 0 auto; }
        .test-box { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border-left: 4px solid #FF6B35;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-box h2 { margin: 0 0 10px 0; color: #333; }
        .result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace;
            font-size: 12px;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .loading { 
            background: #e2e3e5; 
            color: #383d41; 
            border: 1px solid #d6d8db;
        }
        button {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover { background: #E55A24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ MUMMY API Test Suite</h1>
        
        <div class="test-box">
            <h2>Test 1: Recipe Generation API</h2>
            <p>Tests if the Recipe generation endpoint is responding with the new API key</p>
            <button onclick="testRecipeAPI()">Test Recipe API</button>
            <div id="recipe-result"></div>
        </div>

        <div class="test-box">
            <h2>Test 2: Packing Generation API</h2>
            <p>Tests if the Packing list generation endpoint is responding with the new API key</p>
            <button onclick="testPackingAPI()">Test Packing API</button>
            <div id="packing-result"></div>
        </div>

        <div class="test-box">
            <h2>Test 3: Frontend Gemini API (ChatBot/Recipe)</h2>
            <p>Tests if the frontend can reach Gemini with the new API key</p>
            <button onclick="testFrontendAPI()">Test Frontend API</button>
            <div id="frontend-result"></div>
        </div>

        <div class="test-box">
            <h2>All Tests</h2>
            <button onclick="runAllTests()">üöÄ Run All Tests</button>
            <div id="all-results"></div>
        </div>
    </div>

    <script>
        function showResult(elementId, message, isSuccess = null) {
            const el = document.getElementById(elementId);
            if (isSuccess === null) {
                el.innerHTML = `<div class="result loading">${message}</div>`;
            } else if (isSuccess) {
                el.innerHTML = `<div class="result success">‚úÖ ${message}</div>`;
            } else {
                el.innerHTML = `<div class="result error">‚ùå ${message}</div>`;
            }
        }

        async function testRecipeAPI() {
            showResult('recipe-result', 'Testing recipe API...', null);
            try {
                const response = await fetch('/mummy/backend/generate_recipes.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredients: ['rice', 'dal'],
                        health_status: 'healthy',
                        language: 'en'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showResult('recipe-result', `Recipe API working! Status: ${data.status}`, true);
                    } else {
                        showResult('recipe-result', `API error: ${data.error || 'Unknown error'}`, false);
                    }
                } else {
                    showResult('recipe-result', `HTTP Error: ${response.status} ${response.statusText}`, false);
                }
            } catch (err) {
                showResult('recipe-result', `Connection error: ${err.message}`, false);
            }
        }

        async function testPackingAPI() {
            showResult('packing-result', 'Testing packing API...', null);
            try {
                const response = await fetch('/mummy/backend/generate_packing.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trip_type: 'business',
                        duration: 3,
                        climate: 'warm'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showResult('packing-result', `Packing API working! Items generated: ${data.items ? data.items.length : '?'}`, true);
                    } else {
                        showResult('packing-result', `API error: ${data.error || 'Unknown error'}`, false);
                    }
                } else {
                    showResult('packing-result', `HTTP Error: ${response.status} ${response.statusText}`, false);
                }
            } catch (err) {
                showResult('packing-result', `Connection error: ${err.message}`, false);
            }
        }

        async function testFrontendAPI() {
            showResult('frontend-result', 'Testing frontend Gemini API...', null);
            try {
                // Test if CONFIG is accessible
                if (typeof CONFIG === 'undefined') {
                    showResult('frontend-result', 'CONFIG not loaded. Make sure app.js is loaded.', false);
                    return;
                }

                const response = await fetch(CONFIG.GEMINI_API_URL + `?key=${CONFIG.GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: 'Say "Hello" if you can hear me' }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('frontend-result', `Gemini API responding! Model ready.`, true);
                } else if (response.status === 400) {
                    showResult('frontend-result', `HTTP 400: Check API key validity`, false);
                } else if (response.status === 429) {
                    showResult('frontend-result', `HTTP 429: Rate limited (too many requests)`, false);
                } else {
                    showResult('frontend-result', `HTTP Error: ${response.status} ${response.statusText}`, false);
                }
            } catch (err) {
                showResult('frontend-result', `Connection error: ${err.message}`, false);
            }
        }

        async function runAllTests() {
            const allResults = document.getElementById('all-results');
            allResults.innerHTML = '<div class="result loading">Running all tests...</div>';
            
            await new Promise(r => setTimeout(r, 500));
            testRecipeAPI();
            
            await new Promise(r => setTimeout(r, 1000));
            testPackingAPI();
            
            await new Promise(r => setTimeout(r, 1000));
            testFrontendAPI();
            
            allResults.innerHTML = '<div class="result success">‚úÖ All tests completed! Check results above.</div>';
        }
    </script>
</body>
</html>
